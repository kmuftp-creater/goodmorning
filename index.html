<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
  <title>å•å®‰åœ–ç”¢ç”Ÿå™¨ï½œå…è²»ç·šä¸Šæ—©å®‰åœ–è£½ä½œå·¥å…· v0.0.5</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- å¼•å…¥ Inter (è‹±æ•¸) èˆ‡ Noto (ä¸­æ–‡) å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&family=LXGW+WenKai+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* 1. æ ¸å¿ƒè‰²ç›¤ (Color Palette) */
      --color-primary: #4A90E2;
      --color-primary-dark: #3A78C4;
      --color-primary-light: #EBF3FB;
      --color-bg: #F5F7FA;
      --color-surface: #FFFFFF;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E5E7EB;
      
      /* 2. ç‹€æ…‹è‰²å½© (Status Colors) */
      --color-success: #5AC8A5;
      --color-error: #F06292;
      --color-warning: #FFB74D;
      --color-info: #4FC3F7;

      /* 4. å…ƒä»¶é¢¨æ ¼ (Components) - åœ“è§’ */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      
      /* 4. å…ƒä»¶é¢¨æ ¼ (Components) - è¼•å¾®æ“´æ•£é™°å½± */
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      /* 3. æ’ç‰ˆèˆ‡å­—é«” (Typography) */
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      font-size: 16px;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px; /* å¯¬é¬†èˆ’é©çš„ç•™ç™½ */
    }

    .page-header {
      text-align: center;
      margin-bottom: 32px;
      padding-top: 16px;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 8px;
    }

    .greeting-banner {
      color: var(--color-text-light);
      font-size: 1.1rem;
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      align-items: flex-start;
    }

    .controls-col, .preview-col {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .preview-col {
      position: sticky;
      top: 24px;
    }

    .step {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .step-label {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--color-text);
      border-bottom: 2px solid var(--color-bg);
      padding-bottom: 8px;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-sm);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #FAFAFA;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }
    .upload-placeholder svg {
      width: 48px;
      height: 48px;
      color: var(--color-primary);
      margin-bottom: 12px;
    }
    .upload-text { font-weight: 700; font-size: 1.1rem; color: var(--color-text); }
    .upload-hint { color: var(--color-text-light); font-size: 0.9rem; margin-top: 4px; }
    #upload-input { display: none; }
    
    .upload-area.has-image .upload-placeholder { display: none; }
    #preview-thumb {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-sm);
      display: none;
      margin: 0 auto;
    }
    .upload-area.has-image #preview-thumb { display: block; }

    /* Pan Controls */
    .bg-pan { display: none; margin-top: 16px; text-align: center; }
    .bg-pan.show { display: block; }
    .bg-pan-label { font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; display: block; color: var(--color-text); }
    .pan-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      max-width: 160px;
      margin: 0 auto;
    }
    .pan-btn {
      padding: 8px;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 14px;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .pan-btn:hover { background: var(--color-primary-light); color: var(--color-primary-dark); border-color: var(--color-primary-light); }
    .pan-btn.reset { background: var(--color-bg); }

    /* Greetings & Texts */
    .greeting-sub-label { font-weight: 700; margin-bottom: 12px; color: var(--color-text-light); font-size: 0.95rem; }
    .greeting-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .greeting-btn, .wisdom-btn {
      padding: 8px 16px;
      border-radius: var(--radius-sm); /* æŒ‰éˆ• 8px åœ“è§’ */
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .greeting-btn:hover, .wisdom-btn:hover { 
      border-color: var(--color-primary); 
      color: var(--color-primary); 
    }
    .greeting-btn.active, .wisdom-btn.active {
      background: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary);
      font-weight: 500;
    }
    
    /* éš¨æ©Ÿç”¢ç”ŸæŒ‰éˆ•é¢¨æ ¼ */
    .random-btn { 
      background: linear-gradient(135deg, var(--color-info) 0%, var(--color-primary) 100%); 
      color: white; 
      border: none; 
      font-weight: 500;
    }
    .random-btn:hover { opacity: 0.9; color: white; border: none; box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3); }

    textarea {
      width: 100%;
      height: 120px;
      padding: 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      resize: vertical;
      font-family: inherit;
      font-size: 1rem;
      color: var(--color-text);
      background: var(--color-surface);
      transition: all 0.2s;
    }
    textarea:focus { 
      outline: none; 
      border-color: var(--color-primary); 
      box-shadow: 0 0 0 3px var(--color-primary-light); 
    }

    /* Options */
    .option-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .option-label { font-weight: 700; min-width: 50px; color: var(--color-text); }
    
    .pill-btn, .pos-btn {
      padding: 6px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .pill-btn:hover, .pos-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .pill-btn.active, .pos-btn.active { 
      background: var(--color-text); 
      color: var(--color-surface); 
      border-color: var(--color-text); 
    }
    
    .pos-wrap { display: flex; gap: 12px; margin-top: 24px; }
    .pos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
    .pos-btn { border-radius: var(--radius-sm); padding: 6px 12px; font-size: 0.85rem; }

    .color-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .color-dot:hover { transform: scale(1.1); }
    .color-dot.active { box-shadow: 0 0 0 2px var(--color-surface), 0 0 0 4px var(--color-text); }

    /* Stickers */
    .sticker-grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      padding-bottom: 12px;
    }
    .sticker-item-wrap { text-align: center; }
    .sticker-thumb {
      width: 64px;
      height: 64px;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--color-surface);
      transition: all 0.2s;
    }
    .sticker-thumb img { width: 40px; height: 40px; }
    .sticker-thumb:hover { border-color: var(--color-primary); }
    .sticker-thumb.active { border-color: var(--color-primary); background: var(--color-primary-light); }
    .sticker-name { font-size: 0.85rem; margin-top: 6px; color: var(--color-text-light); }
    
    .sticker-controls { display: none; background: var(--color-bg); padding: 16px; border-radius: var(--radius-sm); margin-top: 16px; border: 1px solid var(--color-border); }
    .sticker-controls.show { display: block; }
    .sticker-controls-title { font-weight: 700; margin-bottom: 12px; color: var(--color-text); }
    .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .slider-row input[type="range"] { flex: 1; accent-color: var(--color-primary); }

    /* Canvas */
    .preview-wrap {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: var(--color-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--color-border);
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    .btn-primary {
      width: 100%;
      padding: 16px;
      background: var(--color-primary);
      color: var(--color-surface);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
    }
    .btn-primary:hover:not(:disabled) { 
      background: var(--color-primary-dark); 
      box-shadow: 0 6px 16px rgba(74, 144, 226, 0.3);
      transform: translateY(-1px);
    }
    .btn-primary:disabled { 
      background: var(--color-border); 
      cursor: not-allowed; 
      color: var(--color-text-light); 
      box-shadow: none;
      transform: none;
    }
    .btn-primary svg { width: 24px; height: 24px; }

    /* Overlays */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(51, 51, 51, 0.9);
      color: var(--color-surface);
      padding: 12px 24px;
      border-radius: 30px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      opacity: 0;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    .save-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    .save-overlay.show { display: flex; }
    .save-overlay-hint { color: var(--color-surface); text-align: center; font-size: 1.2rem; margin-bottom: 24px; font-weight: 500; }
    #save-overlay-img { max-width: 90%; max-height: 70vh; border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .save-overlay-close {
      margin-top: 24px; padding: 12px 32px; background: var(--color-surface); border: none; border-radius: var(--radius-sm);
      font-weight: 700; cursor: pointer; color: var(--color-text); transition: background 0.2s;
    }
    .save-overlay-close:hover { background: var(--color-bg); }

    .footer { 
      text-align: center; 
      margin-top: 48px; 
      color: var(--color-text-light); 
      font-size: 0.9rem; 
      border-top: 1px solid var(--color-border); 
      padding-top: 24px; 
    }
    .footer a { color: var(--color-primary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .footer a:hover { color: var(--color-primary-dark); text-decoration: underline; }
  </style>
</head>
<body>
<div class="page">
  <header class="page-header">
    <h1>å•å®‰åœ–ç”¢ç”Ÿå™¨</h1>
    <p class="greeting-banner" id="greeting-banner"></p>
  </header>

  <div class="layout">
    <!-- â”€â”€â”€ Controls Column â”€â”€â”€ -->
    <div class="controls-col">
      <!-- Step 1 -->
      <div class="step">
        <div class="step-label">1. é¸ä¸€å¼µèƒŒæ™¯</div>
        <div class="upload-area" id="upload-area">
          <div class="upload-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="var(--radius-sm)"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            <div class="upload-text">é»é€™è£¡é¸ç…§ç‰‡</div>
            <div class="upload-hint">æˆ–æŠŠåœ–ç‰‡æ‹–é€²ä¾†</div>
          </div>
          <img id="preview-thumb" alt="èƒŒæ™¯é è¦½">
        </div>
        <input type="file" id="upload-input" accept="image/*">
        <div class="bg-pan" id="bg-pan">
          <span class="bg-pan-label">èª¿æ•´ç•«é¢<span style="font-size:0.8rem; color:var(--color-text-light); margin-left:8px; font-weight:400;">å¤šé»å¹¾ä¸‹å¯ä»¥ç§»æ›´å¤š</span></span>
          <div class="pan-grid">
            <button class="pan-btn reset" data-dir="top-left">å·¦ä¸Š</button>
            <button class="pan-btn" data-dir="up">ä¸Š</button>
            <button class="pan-btn reset" data-dir="top-right">å³ä¸Š</button>
            <button class="pan-btn" data-dir="left">å·¦</button>
            <button class="pan-btn reset" data-dir="reset">ç½®ä¸­</button>
            <button class="pan-btn" data-dir="right">å³</button>
            <button class="pan-btn reset" data-dir="bot-left">å·¦ä¸‹</button>
            <button class="pan-btn" data-dir="down">ä¸‹</button>
            <button class="pan-btn reset" data-dir="bot-right">å³ä¸‹</button>
          </div>
        </div>
        
        <div class="option-row" style="margin-top: 24px;">
          <span class="option-label">åº•è‰²</span>
          <div class="color-dot bg-color-dot active" data-color="#EBF3FB" style="background:#EBF3FB; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#F5F7FA" style="background:#F5F7FA; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#FFE4E1" style="background:#FFE4E1; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#E0FFFF" style="background:#E0FFFF; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#FFFACD" style="background:#FFFACD; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#E6E6FA" style="background:#E6E6FA; border-color:#CCC;"></div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step">
        <div class="step-label">2. é¸å•å€™èª</div>

        <div class="greeting-section">
          <div class="greeting-sub-label">åŸºæœ¬å•å€™</div>
          <div class="greeting-row" id="basic-row"></div>
        </div>
        <div class="greeting-section">
          <div class="greeting-sub-label">ç²¾é¸èªéŒ„</div>
          <div class="greeting-row" id="wisdom-row"></div>
        </div>

        <textarea id="text-input" placeholder="åœ¨é€™è£¡æ‰“å­—..."></textarea>

        <div class="option-row">
          <span class="option-label">å­—é«”</span>
          <button class="pill-btn font-btn active" data-font="gensenrounded">é è¨­</button>
          <button class="pill-btn font-btn" data-font="wenkai">æ¥·é«”</button>
          <button class="pill-btn font-btn" data-font="notoserif">æ˜é«”</button>
          <button class="pill-btn font-btn" data-font="notosans">é»‘é«”</button>
          <button class="pill-btn font-btn" data-font="zenmaru">åœ“é«”</button>
          <button class="pill-btn font-btn" data-font="jhenghei">å¾®è»Ÿæ­£é»‘</button>
          <button class="pill-btn font-btn" data-font="hanserif">Han Serif</button>
        </div>

        <div class="option-row">
          <span class="option-label">é¡è‰²</span>
          <!-- é‡æ–°æ’åˆ—é¡è‰²ï¼Œä¸¦ç§»é™¤é»‘è‰²ã€å’–å•¡è‰²èˆ‡ç‰¹å®šè—è‰² -->
          <div class="color-dot text-color-dot active" data-color="#FFFFFF" style="background:#FFFFFF; border-color:#CCC;"></div>
          <div class="color-dot text-color-dot" data-color="#FFFF00" style="background:#FFFF00"></div>
          <div class="color-dot text-color-dot" data-color="#FFD700" style="background:#FFD700"></div>
          <div class="color-dot text-color-dot" data-color="#FFB89A" style="background:#FFB89A"></div>
          <div class="color-dot text-color-dot" data-color="#F5D0C5" style="background:#F5D0C5"></div>
          <div class="color-dot text-color-dot" data-color="#FF6B6B" style="background:#FF6B6B"></div>
          <div class="color-dot text-color-dot" data-color="#C4B7D7" style="background:#C4B7D7"></div>
          <div class="color-dot text-color-dot" data-color="#7FA890" style="background:#7FA890"></div>
        </div>

        <div class="option-row">
          <span class="option-label">å¤§å°</span>
          <button class="pill-btn size-btn" data-size="36">å°</button>
          <button class="pill-btn size-btn active" data-size="52">ä¸­</button>
          <button class="pill-btn size-btn" data-size="72">å¤§</button>
        </div>

        <div class="pos-wrap">
          <span class="option-label">ä½ç½®</span>
          <div class="pos-grid">
            <button class="pos-btn" data-pos="tl">å·¦ä¸Š</button>
            <button class="pos-btn" data-pos="tc">ä¸Š</button>
            <button class="pos-btn" data-pos="tr">å³ä¸Š</button>
            <button class="pos-btn" data-pos="ml">å·¦</button>
            <button class="pos-btn active" data-pos="mc">ä¸­</button>
            <button class="pos-btn" data-pos="mr">å³</button>
            <button class="pos-btn" data-pos="bl">å·¦ä¸‹</button>
            <button class="pos-btn" data-pos="bc">ä¸‹</button>
            <button class="pos-btn" data-pos="br">å³ä¸‹</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Stickers -->
      <div class="step">
        <div class="step-label">3. åŠ å€‹è²¼åœ–</div>
        <div class="greeting-sub-label">é»é¸å³å¯åŠ åˆ°åœ–ä¸Šï¼Œå†é»ä¸€æ¬¡å–æ¶ˆ</div>
        <div class="sticker-grid" id="sticker-grid"></div>
        <div class="sticker-controls" id="sticker-controls">
          <div class="sticker-controls-title" id="sticker-controls-title"></div>
          <div class="slider-row">
            <span class="slider-label">å·¦å³</span>
            <input type="range" id="sticker-x" min="0" max="700" value="0">
          </div>
          <div class="slider-row">
            <span class="slider-label">ä¸Šä¸‹</span>
            <input type="range" id="sticker-y" min="0" max="700" value="0">
          </div>
          <div class="slider-row">
            <span class="slider-label">å¤§å°</span>
            <input type="range" id="sticker-size" min="60" max="400" value="130">
          </div>
        </div>
      </div>

    </div><!-- /.controls-col -->

    <!-- â”€â”€â”€ Preview Column â”€â”€â”€ -->
    <div class="preview-col">
      <div class="step">
        <div class="step-label">4. é è¦½å’Œä¸‹è¼‰</div>
        <div class="preview-wrap">
          <canvas id="canvas" width="800" height="800"></canvas>
        </div>
      </div>

      <button class="btn-primary" id="btn-download" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        ä¸‹è¼‰åœ–ç‰‡
      </button>
    </div><!-- /.preview-col -->

  </div><!-- /.layout -->

  <footer class="footer">
    <p>v0.0.5 | Â©2026 <a href="https://huobest.com/" target="_blank">éœå®¶ç§å¡¾</a></p>
  </footer>
</div>

<div class="save-overlay" id="save-overlay">
  <div class="save-overlay-hint" id="save-overlay-hint"></div>
  <img id="save-overlay-img" alt="å•å®‰åœ–">
  <button class="save-overlay-close" id="save-overlay-close">é—œé–‰</button>
</div>
<div class="toast" id="toast"></div>

<script>
  // â”€â”€â”€ Time â”€â”€â”€
  function getTimeGreeting() {
    const h = new Date().getHours();
    if (h >= 5 && h < 12) return 'æ—©å®‰';
    if (h >= 12 && h < 18) return 'åˆå®‰';
    return 'æ™šå®‰';
  }
  function getDateTimeStr() {
    const now = new Date();
    const m = now.getMonth() + 1, d = now.getDate();
    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][now.getDay()];
    const hours = now.getHours(), mins = String(now.getMinutes()).padStart(2,'0');
    const period = hours < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ', h12 = hours % 12 || 12;
    return `${m}æœˆ${d}æ—¥ æ˜ŸæœŸ${w} ${period}${h12}:${mins}`;
  }

  // â”€â”€â”€ Data â”€â”€â”€
  const BASIC = ['æ—©å®‰','åˆå®‰','æ™šå®‰','åƒé£½äº†å—','å¤©å†·è¨˜å¾—åŠ è¡£æœ','è¨˜å¾—å¤šå–æ°´'];
  
  // æ–°ç‰ˆæ‰€æœ‰èªéŒ„ (å…±34æ¢)
  const NEW_GREETINGS = [
    'è¦ªæ„›çš„æœ‹å‹ï¼è¨˜å¾—æ¯å¤©å¤šæ„›è‡ªå·±ä¸€é»é»å‘¦ã€‚',
    'æ¯å¤©ä¿æŒå¥½å¿ƒæƒ…ï¼Œæ‰èƒ½å……å¯¦åˆå¿«æ´»ï¼',
    'ç¥ä¸€åˆ‡å®‰å¥½ï¼Œé †åˆ©ï¼Œå¹¸ç¦',
    'ç´¯äº†ï¼Œä¸è¦ç¡¬æ’è‘—',
    'å‘¼å¸å§ï¼Œä½ é‚„æ´»è‘—',
    'ç”Ÿå‘½åªå­˜åœ¨æ–¼ç•¶ä¸‹ã€‚å¤±å»äº†ç•¶ä¸‹å°±æ˜¯å¤±å»äº†ç”Ÿå‘½',
    'æˆ‘å€‘çš„æ„›ï¼Œæ‡‰è©²æ˜¯ç‚ºæˆ‘å€‘æ‰€æ„›çš„äººå¸¶ä¾†å’Œå¹³å’Œå¹¸ç¦ã€‚',
    'å¾®ç¬‘å§ï¼Œç”Ÿå‘½æ˜¯ç¾å¥½çš„',
    'ç¨®å­å†é£½æ»¿ï¼Œä¹Ÿéœ€è¦å¤§åœ°çš„æ»‹é¤Š',
    'æƒ³åƒåŠ›æ¯”çŸ¥è­˜æ›´é‡è¦',
    'åªæœ‰æ”¾æ£„å˜—è©¦çš„ï¼Œæ‰æ˜¯å¤±æ•—è€…',
    'å”¯æœ‰é‚£äº›ç•°æƒ³å¤©é–‹çš„äººï¼Œæ‰èƒ½å®Œæˆä¸å¯èƒ½çš„äº‹',
    'äººç”Ÿå°±åƒé¨å–®è»Šã€‚æƒ³ä¿æŒå¹³è¡¡å°±å¾—å¾€å‰èµ°',
    'å‹èª¼èƒ½å¢é€²å¿«æ¨‚ï¼Œæ¸›å°‘ç—›è‹¦',
    'æœ‰åƒ¹å€¼çš„æ±è¥¿ï¼Œéƒ½éœ€è¦ä»˜å‡ºä»£åƒ¹',
    'æˆåŠŸçš„å”¯ä¸€ç§˜è¨£â€”â€”å …æŒæœ€å¾Œä¸€åˆ†é˜',
    'æ¨é–‹çª—ï¼Œæ“æŠ±é™½å…‰ï¼Œç¥ä½ ä»Šå¤©æ„‰å¿«ç¾å¥½',
    'å¥½å¥½ç…§é¡§è‡ªå·±ï¼Œå°±æ˜¯ä»Šå¤©æœ€å¥½çš„ç¥ç¦ï¼',
    'é¢å°è¤‡é›œï¼Œä¿æŒæ­¡å–œã€‚åŠ æ²¹ï¼',
    'é¡˜ä½ å¾®ç¬‘ä»Šå¤©ï¼Œå¿«æ¨‚æ°¸é ï¼',
    'ç„¡è«–èº«å±…ä½•è™•ï¼Œå¦‚æœå¾—ä»¥å·å¾—ä¸€åˆ»å®‰é–’åä¸‹ä¾†ï¼Œå°±ç•¶äº«å—é‚£ä¸€åˆ»ï¼Œäº«å—æ²’æœ‰ä»€éº¼è¦åšï¼Œåƒ…åƒ…åªæ˜¯äº«å—ä½ çš„å‘¼å¸ã€‚',
    'å®Œç¾ä¸‹åˆåˆä¾†åˆ°ï¼Œç¥ä½ é€™å¤©å¥½æƒ…ç·’ï¼Œå·¥ä½œé †åˆ©ï¼Œç”Ÿæ´»ç”œç¾',
    'å¿™ç¢Œç¸½æ˜¯ç†ç”±ï¼Œç‰½æ›ç¸½æ˜¯ä¸»é¡Œï¼Œé»˜é»˜åœ°ç¥ç¦ä½ ï¼Œç…§é¡§å¥½è‡ªå·±ï¼Œä¸€åˆ‡å¹³å®‰é †åˆ©ï¼',
    'ä¸€å¤©å·²ç¶“éå»ä¸€åŠï¼Œèªªè²ä¸‹åˆå¥½ï¼Œæ‰“èµ·ç²¾ç¥ï¼Œç›¡å¿«å®Œæˆå·¥ä½œï¼Œæ—©é»å›å®¶åƒé£¯ï¼',
    'åœ¨æ™‚å…‰ç©¿æ¢­çš„æ—¥å­è£¡ï¼Œå¿™ç¢Œçš„ç¸½æ˜¯èº«å½±ï¼Œå¤šä¿é‡èº«é«”ï¼Œé¡˜ä½ å¹¸ç¦å®‰åº·ï¼Œå¿«æ¨‚è‡ªåœ¨ï¼',
    'å–æ¯èŒ¶ï¼Œä¼‘æ¯æ™‚åˆ»å°‘ä¸äº†ï¼Œç¥ç¦åˆ°ï¼Œè½‰æ›å¿ƒæƒ…æ›´ç¾å¦™ï¼',
    'å‹ç´¯äº†ä¸€å¤©ï¼Œé¡˜æˆ‘è¼•è¼•çš„ä¸€è²å•å€™ï¼Œä¼´ä½ è¼•é¬†å…¥å¤¢ï¼Œæ™šå®‰ï¼',
    'å®‰éœæ¬£è³å¤œæ™¯ï¼Œå°‡å–§é¬§æ­¸é›¶ï¼›æ…¢æ…¢å–æ¯ç‰›å¥¶ï¼Œå°‡å¿™ç¢Œæ­¸é›¶ã€‚æ™šå®‰ï¼',
    'é¡˜ä½ çš„äººç”Ÿå¹³å®‰ä¸€ç¨‹åˆä¸€ç¨‹ï¼Œé¡˜æ‰€æœ‰çš„ç¾å¥½è£æ»¿æ‚¨çš„å¤¢ï¼Œç¥ä½ ä»Šæ™šå¥½å¤¢ã€‚',
    'ä¸è¦æäººæ†‚å¤©ï¼Œç…©æƒ±ä¸¦ä¸æœƒæ¸›å°‘æ˜å¤©çš„è² æ“”ï¼Œå»æœƒå¤±å»ä»Šå¤©çš„å¿«æ¨‚ï¼Œæ™šå®‰ï¼',
    'è®“ç–²æ†Šçš„èº«é«”æ…¢æ…¢å…¥ç¡ï¼Œé¡˜ä½ åšä¸€å€‹å¥½å¤¢ï¼Œå¤¢ä¸­æµæ˜Ÿæ»‘è½è®“ä½ é¡˜æœ›æˆçœŸï¼Œæ™šå®‰ï¼',
    'å¦‚æœå¿ƒå€¦äº†å°±æ‰¾å€‹æ™‚é–“ä¼‘æ¯ï¼Œå¦ç„¶é‡‹æ‡·äº†æ‰èƒ½å¥½å¥½çš„æ”¾é¬†ã€‚æ™šå®‰ï¼',
    'é¡˜çšæ½”çš„æœˆå…‰ç‘æ»¿çª—å‰ï¼Œé¡˜ç¹æ˜Ÿçš„é»é»ä¼´ä½ å¾®ç¬‘å…¥çœ ï¼Œé¡˜è¼•è¼•çš„ç¥ç¦é€ä½ ä¸€â€‹â€‹å¤œé¦™ç”œã€‚æ™šå®‰ï¼',
    'æ™šéœæŠ«è‘—æˆ‘çš„å•å€™ï¼Œçµ¦ä½ å¸¶ä¾†æº«æš–ï¼›å¤œé¢¨ç¨è‘—æˆ‘çš„ç‰½æ›ï¼Œç¥ä½ æ™šå®‰å¥½å¤¢ï¼'
  ];

  // ç•«é¢åªé¡¯ç¤ºå‰ 10 æ¢
  const DISPLAY_GREETINGS = NEW_GREETINGS.slice(0, 10);
  
  const FONTS = {
    gensenrounded: '"Noto Sans TC", sans-serif',
    wenkai: '"LXGW WenKai TC", serif',
    notoserif: '"Noto Serif TC", serif',
    notosans: '"Noto Sans TC", sans-serif',
    zenmaru: '"Zen Maru Gothic", sans-serif',
    jhenghei: '"Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", "Noto Sans TC", sans-serif',
    hanserif: '"Noto Serif TC", "Source Han Serif TC", serif',
  };

  // â”€â”€â”€ Sticker Config (ä½¿ç”¨å…§åµŒ SVG Emoji èˆ‡è‡ªè¨‚é«˜å“è³ªå¹¾ä½•åœ–å½¢) â”€â”€â”€
  const createEmojiSVG = (emoji) => `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="80">${emoji}</text></svg>`)}`;
  
  const createCustomSVG = (content) => `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">${content}</svg>`)}`;
  
  const STICKERS = [
    { id:'sunflower', name:'å‘æ—¥è‘µ', src: createEmojiSVG('ğŸŒ»'), cat:'flowers', dx:60, dy:620 },
    { id:'butterfly', name:'è´è¶', src: createEmojiSVG('ğŸ¦‹'), cat:'animals', dx:620, dy:60 },
    { id:'sun', name:'å¤ªé™½', src: createCustomSVG(`<circle cx="50" cy="50" r="22" fill="#FFCA28"/><g stroke="#FFCA28" stroke-width="6" stroke-linecap="round"><line x1="50" y1="10" x2="50" y2="18"/><line x1="50" y1="82" x2="50" y2="90"/><line x1="10" y1="50" x2="18" y2="50"/><line x1="82" y1="50" x2="90" y2="50"/><line x1="22" y1="22" x2="28" y2="28"/><line x1="78" y1="78" x2="72" y2="72"/><line x1="22" y1="78" x2="28" y2="72"/><line x1="78" y1="22" x2="72" y2="28"/></g>`), cat:'nature', dx:340, dy:340 },
    { id:'lotus', name:'è“®èŠ±', src: createCustomSVG(`<path d="M50 85 C 15 85 5 50 25 40 C 35 45 40 70 50 85 Z" fill="#81C784"/><path d="M50 85 C 85 85 95 50 75 40 C 65 45 60 70 50 85 Z" fill="#81C784"/><path d="M50 85 C 20 70 15 35 35 25 C 45 35 45 60 50 85 Z" fill="#FF9EBB"/><path d="M50 85 C 80 70 85 35 65 25 C 55 35 55 60 50 85 Z" fill="#FF9EBB"/><path d="M50 85 C 25 80 20 45 30 35 C 40 50 45 65 50 85 Z" fill="#FF7096"/><path d="M50 85 C 75 80 80 45 70 35 C 60 50 55 65 50 85 Z" fill="#FF7096"/><path d="M50 85 C 35 85 35 30 50 15 C 65 30 65 85 50 85 Z" fill="#FF477E"/>`), cat:'flowers', dx:620, dy:620 },
    { id:'heart', name:'æ„›å¿ƒ', src: createCustomSVG(`<path d="M 50 30 A 20 20 0 0 0 10 30 C 10 60 50 85 50 85 C 50 85 90 60 90 30 A 20 20 0 0 0 50 30 Z" fill="#FF4B4B"/><path d="M 22 25 A 12 12 0 0 1 35 15" fill="none" stroke="#FFC0CB" stroke-width="4" stroke-linecap="round"/>`), cat:'symbols', dx:340, dy:640 },
    { id:'coffee', name:'å’–å•¡', src: createCustomSVG(`<path d="M 25 30 L 25 70 C 25 85 75 85 75 70 L 75 30 Z" fill="#FFE082"/><path d="M 75 40 C 95 40 95 65 75 65" fill="none" stroke="#FFE082" stroke-width="8" stroke-linecap="round"/><path d="M 35 30 L 65 30" stroke="#8D6E63" stroke-width="6" stroke-linecap="round"/><circle cx="40" cy="55" r="3" fill="#5D4037"/><circle cx="60" cy="55" r="3" fill="#5D4037"/><path d="M 45 60 Q 50 65 55 60" fill="none" stroke="#5D4037" stroke-width="3" stroke-linecap="round"/><path d="M 40 20 Q 35 10 45 5" fill="none" stroke="#BDBDBD" stroke-width="4" stroke-linecap="round"/><path d="M 60 20 Q 55 10 65 5" fill="none" stroke="#BDBDBD" stroke-width="4" stroke-linecap="round"/>`), cat:'food', dx:60, dy:340 },
    { id:'sparkle', name:'æ˜Ÿæ˜Ÿ', src: createCustomSVG(`<polygon points="50,15 61,35 84,35 66,52 73,75 50,60 27,75 34,52 16,35 39,35" fill="#FFD54F" stroke="#FFB300" stroke-width="3" stroke-linejoin="round"/><circle cx="42" cy="48" r="3" fill="#8D6E63"/><circle cx="58" cy="48" r="3" fill="#8D6E63"/><path d="M 47 54 Q 50 58 53 54" fill="none" stroke="#8D6E63" stroke-width="3" stroke-linecap="round"/>`), cat:'symbols', dx:340, dy:60 },
    { id:'sakura', name:'æ«»èŠ±', src: createEmojiSVG('ğŸŒ¸'), cat:'flowers', dx:60, dy:60 },
    { id:'clover', name:'å¹¸é‹è‰', src: createEmojiSVG('ğŸ€'), cat:'plants', dx:620, dy:340 }
  ];

  // â”€â”€â”€ State â”€â”€â”€
  let bgImage = null;
  let bgPanX = 0, bgPanY = 0;
  let bgColor = '#EBF3FB';
  let greetingColor = '#FFFFFF';
  let fontSize = 52;
  let fontKey = 'gensenrounded';
  let textPos = 'mc';
  const activeStickers = new Set();
  const stickerImages = {};
  const stickerState = {};
  let selectedSticker = null;

  // â”€â”€â”€ DOM â”€â”€â”€
  const uploadArea = document.getElementById('upload-area');
  const uploadInput = document.getElementById('upload-input');
  const previewThumb = document.getElementById('preview-thumb');
  const textInput = document.getElementById('text-input');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const btnDownload = document.getElementById('btn-download');
  const toastEl = document.getElementById('toast');
  const bannerEl = document.getElementById('greeting-banner');

  // â”€â”€â”€ Helpers â”€â”€â”€
  function clearGreetingActive() {
    document.querySelectorAll('.greeting-btn, .wisdom-btn').forEach(b => b.classList.remove('active'));
  }
  function fillBasic(t) { textInput.value = `${t}ï¼\n${getDateTimeStr()}`; draw(); }
  function fillWisdom(t) { textInput.value = `${t}\n${getDateTimeStr()}`; draw(); } // ç§»é™¤äº†ã€Œâ€” ä¸€è¡Œç¦ªå¸«ã€å¾Œç¶´

  // â”€â”€â”€ Greeting Banner â”€â”€â”€
  (function() {
    const now = new Date(), hours = now.getHours(), mins = String(now.getMinutes()).padStart(2,'0');
    const period = hours < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ', h12 = hours % 12 || 12;
    bannerEl.innerHTML = `${getTimeGreeting()}ï¼ç¾åœ¨æ˜¯${period}${h12}é»${mins}åˆ†<br>ç‚ºæ‚¨æº–å‚™å°ˆå±¬å•å®‰åœ–`;
  })();

  // â”€â”€â”€ Greeting Buttons â”€â”€â”€
  const autoG = getTimeGreeting();
  BASIC.forEach(g => {
    const btn = document.createElement('button');
    btn.className = 'greeting-btn' + (g === autoG ? ' active' : '');
    btn.textContent = g;
    btn.addEventListener('click', () => { clearGreetingActive(); btn.classList.add('active'); fillBasic(g); });
    document.getElementById('basic-row').appendChild(btn);
  });
  
  // é¡¯ç¤ºå‰ 10 æ¢
  DISPLAY_GREETINGS.forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'wisdom-btn';
    // æˆªæ–·éé•·æ–‡å­—åœ¨æŒ‰éˆ•ä¸Šçš„é¡¯ç¤º
    btn.textContent = w.length > 8 ? w.substring(0, 8) + '...' : w;
    btn.title = w;
    btn.addEventListener('click', () => { clearGreetingActive(); btn.classList.add('active'); fillWisdom(w); });
    document.getElementById('wisdom-row').appendChild(btn);
  });
  
  // éš¨æ©Ÿç”¢ç”ŸæŒ‰éˆ• (å¾å…¨éƒ¨ 34 æ¢éš¨æ©ŸæŠ½)
  (function() {
    const btn = document.createElement('button');
    btn.className = 'wisdom-btn random-btn';
    btn.textContent = 'éš¨æ©Ÿç”¢ç”Ÿ ğŸ²';
    btn.addEventListener('click', () => {
      clearGreetingActive();
      btn.classList.add('active');
      fillWisdom(NEW_GREETINGS[Math.floor(Math.random() * NEW_GREETINGS.length)]);
    });
    document.getElementById('wisdom-row').appendChild(btn);
  })();
  
  fillBasic(autoG);

  // â”€â”€â”€ Sticker Setup â”€â”€â”€
  const stickerGrid = document.getElementById('sticker-grid');
  const stickerControlsEl = document.getElementById('sticker-controls');
  const stickerTitleEl = document.getElementById('sticker-controls-title');
  const sliderX = document.getElementById('sticker-x');
  const sliderY = document.getElementById('sticker-y');
  const sliderSize = document.getElementById('sticker-size');

  function selectStickerControls(id) {
    if (!id || !activeStickers.has(id)) {
      selectedSticker = null;
      stickerControlsEl.classList.remove('show');
      return;
    }
    selectedSticker = id;
    const s = STICKERS.find(st => st.id === id);
    const st = stickerState[id];
    stickerTitleEl.textContent = `èª¿æ•´ã€Œ${s.name}ã€`;
    sliderX.value = st.x; sliderY.value = st.y; sliderSize.value = st.size;
    stickerControlsEl.classList.add('show');
  }

  STICKERS.forEach(s => {
    const img = new Image();
    img.src = s.src;
    img.onload = () => draw();
    stickerImages[s.id] = img;
    stickerState[s.id] = { x: s.dx, y: s.dy, size: 130 };

    const wrap = document.createElement('div');
    wrap.className = 'sticker-item-wrap';
    const thumb = document.createElement('div');
    thumb.className = 'sticker-thumb';
    const thumbImg = document.createElement('img');
    thumbImg.src = s.src;
    thumb.appendChild(thumbImg);
    
    thumb.addEventListener('click', () => {
      if (activeStickers.has(s.id)) {
        activeStickers.delete(s.id);
        thumb.classList.remove('active');
        if (selectedSticker === s.id) selectStickerControls(null);
      } else {
        activeStickers.add(s.id);
        thumb.classList.add('active');
        selectStickerControls(s.id);
      }
      draw();
    });
    const label = document.createElement('div');
    label.className = 'sticker-name';
    label.textContent = s.name;
    wrap.appendChild(thumb); wrap.appendChild(label);
    stickerGrid.appendChild(wrap);
  });

  ['x','y','size'].forEach(attr => {
    document.getElementById(`sticker-${attr}`).addEventListener('input', (e) => {
      if (!selectedSticker) return;
      stickerState[selectedSticker][attr] = parseInt(e.target.value);
      draw();
    });
  });

  // â”€â”€â”€ Upload â”€â”€â”€
  uploadArea.addEventListener('click', () => uploadInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
  uploadArea.addEventListener('drop', e => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  uploadInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

  function handleFile(file) {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        bgImage = img; bgPanX = 0; bgPanY = 0;
        previewThumb.src = e.target.result;
        uploadArea.classList.add('has-image');
        btnDownload.disabled = false;
        document.getElementById('bg-pan').classList.add('show');
        draw();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // â”€â”€â”€ Background Pan â”€â”€â”€
  document.querySelectorAll('.pan-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!bgImage) return;
      const dir = btn.dataset.dir;
      const w = 800, h = 800;
      const sc = Math.max(w / bgImage.width, h / bgImage.height);
      const sw = bgImage.width * sc, sh = bgImage.height * sc;
      const maxX = (sw - w) / 2, maxY = (sh - h) / 2;
      const step = 40;
      if (dir === 'up') bgPanY = Math.min(bgPanY + step, maxY);
      else if (dir === 'down') bgPanY = Math.max(bgPanY - step, -maxY);
      else if (dir === 'left') bgPanX = Math.min(bgPanX + step, maxX);
      else if (dir === 'right') bgPanX = Math.max(bgPanX - step, -maxX);
      else if (dir === 'reset') { bgPanX = 0; bgPanY = 0; }
      else if (dir === 'top-left') { bgPanX = maxX; bgPanY = maxY; }
      else if (dir === 'top-right') { bgPanX = -maxX; bgPanY = maxY; }
      else if (dir === 'bot-left') { bgPanX = maxX; bgPanY = -maxY; }
      else if (dir === 'bot-right') { bgPanX = -maxX; bgPanY = -maxY; }
      draw();
    });
  });

  // â”€â”€â”€ Events (Font, Color, Size, Pos, Text) â”€â”€â”€
  document.querySelectorAll('.font-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      fontKey = btn.dataset.font;
      const fam = FONTS[fontKey].split(',')[0].trim().replace(/"/g,'');
      try { await document.fonts.load(`bold ${fontSize}px "${fam}"`); } catch(e){}
      draw();
    });
  });

  document.querySelectorAll('.text-color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      document.querySelectorAll('.text-color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      greetingColor = dot.dataset.color;
      draw();
    });
  });

  document.querySelectorAll('.bg-color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      document.querySelectorAll('.bg-color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      bgColor = dot.dataset.color;
      draw();
    });
  });

  document.querySelectorAll('.size-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      fontSize = parseInt(btn.dataset.size); draw();
    });
  });

  document.querySelectorAll('.pos-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      textPos = btn.dataset.pos; draw();
    });
  });

  textInput.addEventListener('input', draw);

  // â”€â”€â”€ Draw Canvas â”€â”€â”€
  function draw() {
    const w = 800, h = 800;
    canvas.width = w; canvas.height = h;

    if (bgImage) {
      const sc = Math.max(w / bgImage.width, h / bgImage.height);
      const sw = bgImage.width * sc, sh = bgImage.height * sc;
      ctx.drawImage(bgImage, (w - sw) / 2 + bgPanX, (h - sh) / 2 + bgPanY, sw, sh);
    } else {
      ctx.fillStyle = bgColor; // æ”¹ç‚ºæŸ”å’Œçš„å“ç‰Œæ·ºè—åº•è‰²é è¨­æˆ–é¸å–é¡è‰²
      ctx.fillRect(0, 0, w, h);
    }

    STICKERS.forEach(s => {
      if (!activeStickers.has(s.id)) return;
      const img = stickerImages[s.id];
      const st = stickerState[s.id];
      if (img.complete) ctx.drawImage(img, st.x, st.y, st.size, st.size);
    });

    const mainText = textInput.value.trim();
    const rawLines = [];
    
    if (mainText) {
      mainText.split('\n').forEach(line => {
        // è‹¥è©²è¡Œé–‹é ­æœ‰ç ´æŠ˜è™Ÿæˆ–æ˜¯æ—¥æœŸæ ¼å¼ï¼Œå°‡å…¶è¨­å®šç‚ºè¼ƒå°å­—é«”
        const isSmall = line.startsWith('â€”') || line.match(/^\d+æœˆ/);
        rawLines.push({ text: line, small: isSmall });
      });
    }

    if (!rawLines.length) return;

    const fontFamily = FONTS[fontKey];
    const pad = 40;
    const maxTextWidth = w - pad * 2;
    
    // è™•ç†è‡ªå‹•æ›è¡Œ (Word Wrap)
    const wrappedLines = [];
    rawLines.forEach(lineObj => {
      const size = lineObj.small ? Math.round(fontSize * 0.6) : fontSize;
      ctx.font = `bold ${size}px ${fontFamily}`;
      
      let currentLine = '';
      for (let i = 0; i < lineObj.text.length; i++) {
        const char = lineObj.text[i];
        const testLine = currentLine + char;
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxTextWidth && i > 0) {
          wrappedLines.push({ text: currentLine, small: lineObj.small });
          currentLine = char;
        } else {
          currentLine = testLine;
        }
      }
      wrappedLines.push({ text: currentLine, small: lineObj.small });
    });

    const lineH = fontSize * 1.5;
    const totalH = wrappedLines.length * lineH;

    const col = textPos[1], row = textPos[0];
    const hAlign = col === 'l' ? 'left' : col === 'r' ? 'right' : 'center';
    const xPos = col === 'l' ? pad : col === 'r' ? w - pad : w / 2;
    let startY = row === 't' ? pad + fontSize : row === 'b' ? h - totalH - pad + fontSize : (h - totalH) / 2 + fontSize;

    ctx.textAlign = hAlign;
    ctx.textBaseline = 'middle';

    wrappedLines.forEach((line, i) => {
      const y = startY + i * lineH;
      const size = line.small ? Math.round(fontSize * 0.6) : fontSize;
      ctx.font = `bold ${size}px ${fontFamily}`;
      ctx.strokeStyle = 'rgba(0,0,0,0.6)';
      ctx.lineWidth = size * 0.12;
      ctx.lineJoin = 'round';
      ctx.strokeText(line.text, xPos, y);
      ctx.fillStyle = greetingColor;
      ctx.fillText(line.text, xPos, y);
    });
  }
  document.fonts.ready.then(draw);

  // â”€â”€â”€ Download â”€â”€â”€
  btnDownload.addEventListener('click', async () => {
    if (!bgImage) { toast('è«‹å…ˆé¸ä¸€å¼µèƒŒæ™¯ç…§ç‰‡å”·ï¼'); return; }
    const dataUrl = canvas.toDataURL('image/png');
    
    if (/Line\//i.test(navigator.userAgent) || /FBAN|FBAV|Instagram/i.test(navigator.userAgent)) {
      document.getElementById('save-overlay-img').src = dataUrl;
      document.getElementById('save-overlay-hint').innerHTML = 'ğŸ‘† é•·æŒ‰åœ–ç‰‡å„²å­˜<br>å³å¯åˆ†äº«çµ¦è¦ªå‹';
      document.getElementById('save-overlay').classList.add('show');
      return;
    }

    const link = document.createElement('a');
    link.download = `å•å®‰åœ–_${new Date().getTime()}.png`;
    link.href = dataUrl;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    toast('âœ… åœ–ç‰‡å·²æˆåŠŸä¸‹è¼‰ï¼');
  });

  document.getElementById('save-overlay-close').addEventListener('click', () => document.getElementById('save-overlay').classList.remove('show'));

  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 2500);
  }
</script>
</body>
</html>
