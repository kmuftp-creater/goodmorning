<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
  <title>å•å®‰åœ–ç”¢ç”Ÿå™¨ï½œå…è²»ç·šä¸Šæ—©å®‰åœ–è£½ä½œå·¥å…· v0.1.1</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- å¼•å…¥ Inter (è‹±æ•¸) èˆ‡ Noto (ä¸­æ–‡) å­—é«” -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&family=LXGW+WenKai+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* 1. æ ¸å¿ƒè‰²ç›¤ (Color Palette) */
      --color-primary: #4A90E2;
      --color-primary-dark: #3A78C4;
      --color-primary-light: #EBF3FB;
      --color-bg: #F5F7FA;
      --color-surface: #FFFFFF;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E5E7EB;
      
      /* 2. ç‹€æ…‹è‰²å½© (Status Colors) */
      --color-success: #5AC8A5;
      --color-error: #F06292;
      --color-warning: #FFB74D;
      --color-info: #4FC3F7;

      /* 4. å…ƒä»¶é¢¨æ ¼ (Components) - åœ“è§’ */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      
      /* 4. å…ƒä»¶é¢¨æ ¼ (Components) - è¼•å¾®æ“´æ•£é™°å½± */
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      /* 3. æ’ç‰ˆèˆ‡å­—é«” (Typography) */
      font-family: 'Inter', 'Noto Sans TC', sans-serif;
      font-size: 16px;
      background-color: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px; /* å¯¬é¬†èˆ’é©çš„ç•™ç™½ */
    }

    .page-header {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 16px;
      margin-bottom: 32px;
      padding-top: 16px;
      flex-wrap: wrap;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 0;
    }

    .greeting-banner {
      color: var(--color-text-light);
      font-size: 1rem;
      font-weight: 500;
      margin: 0;
    }

    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 32px;
      align-items: flex-start;
    }

    .controls-col, .preview-col {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .preview-col {
      position: sticky;
      top: 24px;
    }

    .step {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .step-label {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--color-text);
      border-bottom: 2px solid var(--color-bg);
      padding-bottom: 8px;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-sm);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #FAFAFA;
    }
    .upload-area:hover, .upload-area.dragover {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }
    .upload-placeholder svg {
      width: 48px;
      height: 48px;
      color: var(--color-primary);
      margin-bottom: 12px;
    }
    .upload-text { font-weight: 700; font-size: 1.1rem; color: var(--color-text); }
    .upload-hint { color: var(--color-text-light); font-size: 0.9rem; margin-top: 4px; }
    #upload-input { display: none; }
    
    .upload-area.has-image .upload-placeholder { display: none; }
    #preview-thumb {
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-sm);
      display: none;
      margin: 0 auto;
    }
    .upload-area.has-image #preview-thumb { display: block; }

    /* Greetings & Texts */
    .greeting-sub-label { font-weight: 700; margin-bottom: 12px; color: var(--color-text-light); font-size: 0.95rem; }
    .greeting-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .greeting-btn, .wisdom-btn {
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .greeting-btn:hover, .wisdom-btn:hover { 
      border-color: var(--color-primary); 
      color: var(--color-primary); 
    }
    .greeting-btn.active, .wisdom-btn.active {
      background: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary);
      font-weight: 500;
    }
    
    .random-btn { 
      background: linear-gradient(135deg, var(--color-info) 0%, var(--color-primary) 100%); 
      color: white; 
      border: none; 
      font-weight: 500;
    }
    .random-btn:hover { opacity: 0.9; color: white; border: none; box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3); }

    textarea {
      width: 100%;
      height: 120px;
      padding: 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      resize: vertical;
      font-family: inherit;
      font-size: 1rem;
      color: var(--color-text);
      background: var(--color-surface);
      transition: all 0.2s;
    }
    textarea:focus { 
      outline: none; 
      border-color: var(--color-primary); 
      box-shadow: 0 0 0 3px var(--color-primary-light); 
    }

    /* Options */
    .option-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    .option-label { font-weight: 700; min-width: 50px; color: var(--color-text); }
    
    .pill-btn {
      padding: 6px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      cursor: pointer;
      color: var(--color-text);
      transition: all 0.2s;
    }
    .pill-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .pill-btn.active { 
      background: var(--color-text); 
      color: var(--color-surface); 
      border-color: var(--color-text); 
    }

    .color-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .color-dot:hover { transform: scale(1.1); }
    .color-dot.active { box-shadow: 0 0 0 2px var(--color-surface), 0 0 0 4px var(--color-text); }

    /* Stickers */
    .sticker-grid {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      padding-bottom: 12px;
    }
    .sticker-item-wrap { text-align: center; }
    .sticker-thumb {
      width: 64px;
      height: 64px;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--color-surface);
      transition: all 0.2s;
    }
    .sticker-thumb img { width: 40px; height: 40px; pointer-events: none; }
    .sticker-thumb:hover { border-color: var(--color-primary); }
    .sticker-thumb.active { border-color: var(--color-primary); background: var(--color-primary-light); }
    .sticker-name { font-size: 0.85rem; margin-top: 6px; color: var(--color-text-light); }

    /* Canvas Area */
    .canvas-hint {
      background: var(--color-primary-light);
      color: var(--color-primary-dark);
      padding: 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      font-weight: 700;
      text-align: center;
      font-size: 0.95rem;
      border: 1px dashed var(--color-primary);
    }
    
    .preview-wrap {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: var(--color-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--color-border);
      position: relative;
      transition: aspect-ratio 0.3s ease;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
      touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ‹–æ›³æ™‚ç•«é¢æ²å‹• */
      cursor: default;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }
    .btn-primary, .btn-secondary {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--color-primary);
      color: var(--color-surface);
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
    }
    .btn-primary:hover { 
      background: var(--color-primary-dark); 
      box-shadow: 0 6px 16px rgba(74, 144, 226, 0.3);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--color-bg);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }
    .btn-secondary:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }
    
    .btn-primary svg, .btn-secondary svg { width: 24px; height: 24px; }

    /* Overlays */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(51, 51, 51, 0.9);
      color: var(--color-surface);
      padding: 12px 24px;
      border-radius: 30px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      opacity: 0;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    .save-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000;
    }
    .save-overlay.show { display: flex; }
    .save-overlay-hint { color: var(--color-surface); text-align: center; font-size: 1.2rem; margin-bottom: 24px; font-weight: 500; }
    #save-overlay-img { max-width: 90%; max-height: 70vh; border-radius: var(--radius-md); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .save-overlay-close {
      margin-top: 24px; padding: 12px 32px; background: var(--color-surface); border: none; border-radius: var(--radius-sm);
      font-weight: 700; cursor: pointer; color: var(--color-text); transition: background 0.2s;
    }
    .save-overlay-close:hover { background: var(--color-bg); }

    .footer-inline { 
      text-align: center; 
      margin-top: 16px; 
      color: var(--color-text-light); 
      font-size: 0.9rem; 
    }
    .footer-inline a { color: var(--color-primary); text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .footer-inline a:hover { color: var(--color-primary-dark); text-decoration: underline; }
  </style>
</head>
<body>
<div class="page">
  <header class="page-header">
    <h1>å•å®‰åœ–ç”¢ç”Ÿå™¨</h1>
    <p class="greeting-banner">ç‚ºæ‚¨æº–å‚™å°ˆå±¬å•å®‰åœ–</p>
  </header>

  <div class="layout">
    <!-- â”€â”€â”€ Controls Column â”€â”€â”€ -->
    <div class="controls-col">
      <!-- Step 1 -->
      <div class="step">
        <div class="step-label">1. è¨­å®šèƒŒæ™¯</div>
        
        <div class="option-row" style="margin-top: 0; margin-bottom: 20px;">
          <span class="option-label">ç‰ˆå‹</span>
          <button class="pill-btn ratio-btn active" data-ratio="1:1">1:1 (æ­£æ–¹å½¢)</button>
          <button class="pill-btn ratio-btn" data-ratio="9:16">9:16 (æ‰‹æ©Ÿæ»¿ç‰ˆ)</button>
        </div>

        <div class="upload-area" id="upload-area">
          <div class="upload-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="var(--radius-sm)"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            <div class="upload-text">é»æ“Šæ­¤è™•ä¸Šå‚³åœ–ç‰‡</div>
            <div class="upload-hint">ä¸Šå‚³å¾Œå¯ä»¥åœ¨å³å´ç›´æ¥æ‹–æ›³ç¸®æ”¾å–”ï¼</div>
          </div>
          <img id="preview-thumb" alt="èƒŒæ™¯é è¦½">
        </div>
        <input type="file" id="upload-input" accept="image/*">
        
        <div class="option-row" style="margin-top: 24px;">
          <span class="option-label">åº•è‰²</span>
          <div class="color-dot bg-color-dot active" data-color="#EBF3FB" style="background:#EBF3FB; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#F5F7FA" style="background:#F5F7FA; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#FFE4E1" style="background:#FFE4E1; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#E0FFFF" style="background:#E0FFFF; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#FFFACD" style="background:#FFFACD; border-color:#CCC;"></div>
          <div class="color-dot bg-color-dot" data-color="#E6E6FA" style="background:#E6E6FA; border-color:#CCC;"></div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step">
        <div class="step-label">2. é¸å•å€™èª</div>

        <div class="greeting-section">
          <div class="greeting-sub-label">åŸºæœ¬å•å€™</div>
          <div class="greeting-row" id="basic-row"></div>
        </div>
        <div class="greeting-section">
          <div class="greeting-sub-label">ç²¾é¸èªéŒ„</div>
          <div class="greeting-row" id="wisdom-row"></div>
        </div>

        <textarea id="text-input" placeholder="åœ¨é€™è£¡æ‰“å­—..."></textarea>

        <div class="option-row">
          <span class="option-label">å­—é«”</span>
          <button class="pill-btn font-btn active" data-font="gensenrounded">é è¨­</button>
          <button class="pill-btn font-btn" data-font="wenkai">æ¥·é«”</button>
          <button class="pill-btn font-btn" data-font="notoserif">æ˜é«”</button>
          <button class="pill-btn font-btn" data-font="notosans">é»‘é«”</button>
          <button class="pill-btn font-btn" data-font="zenmaru">åœ“é«”</button>
          <button class="pill-btn font-btn" data-font="jhenghei">å¾®è»Ÿæ­£é»‘</button>
          <button class="pill-btn font-btn" data-font="hanserif">æ€æºå®‹é«”</button>
        </div>

        <div class="option-row">
          <span class="option-label">é¡è‰²</span>
          <div class="color-dot text-color-dot active" data-color="#FFFFFF" style="background:#FFFFFF; border-color:#CCC;"></div>
          <div class="color-dot text-color-dot" data-color="#FFFF00" style="background:#FFFF00"></div>
          <div class="color-dot text-color-dot" data-color="#FFD700" style="background:#FFD700"></div>
          <div class="color-dot text-color-dot" data-color="#FFB89A" style="background:#FFB89A"></div>
          <div class="color-dot text-color-dot" data-color="#F5D0C5" style="background:#F5D0C5"></div>
          <div class="color-dot text-color-dot" data-color="#FF6B6B" style="background:#FF6B6B"></div>
          <div class="color-dot text-color-dot" data-color="#C4B7D7" style="background:#C4B7D7"></div>
          <div class="color-dot text-color-dot" data-color="#7FA890" style="background:#7FA890"></div>
        </div>

        <div class="option-row">
          <span class="option-label">ä½ç½®</span>
          <button class="pill-btn" id="btn-center-text">æ–‡å­—ç½®ä¸­</button>
        </div>
      </div>

      <!-- Step 3: Stickers -->
      <div class="step">
        <div class="step-label">3. åŠ å€‹è²¼åœ–</div>
        <div class="greeting-sub-label">é»æ“Šå³å¯åŠ å…¥åœ–ç‰‡ä¸­ï¼Œå¯ä»¥ç›´æ¥åœ¨å³å´é è¦½åœ–æ‹–æ›³ç¸®æ”¾å–”ï¼</div>
        <div class="sticker-grid" id="sticker-grid"></div>
      </div>

    </div><!-- /.controls-col -->

    <!-- â”€â”€â”€ Preview Column â”€â”€â”€ -->
    <div class="preview-col">
      <div class="step">
        <div class="step-label">4. é è¦½å’Œä¸‹è¼‰</div>
        <div class="canvas-hint">ğŸ’¡ æç¤ºï¼šé»æ“Šåœ–ç‰‡ä¸Šçš„æ–‡å­—ã€è²¼åœ–æˆ–èƒŒæ™¯ï¼Œå¯ç›´æ¥æ‹–æ‹‰ç§»å‹•ï¼Œæˆ–ä½¿ç”¨å³ä¸‹è§’è—é» / æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾å¤§å°ï¼</div>
        <div class="preview-wrap" id="preview-wrap">
          <canvas id="canvas" width="1080" height="1080"></canvas>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn-secondary" id="btn-clear">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          æ¸…é™¤é‡ä¾†
        </button>
        <button class="btn-primary" id="btn-download">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          ä¸‹è¼‰åœ–ç‰‡
        </button>
      </div>

      <div class="footer-inline">
        <p>v0.1.1 | Â©2026 <a href="https://huobest.com/" target="_blank">éœå®¶ç§å¡¾</a></p>
      </div>
    </div><!-- /.preview-col -->

  </div><!-- /.layout -->
</div>

<div class="save-overlay" id="save-overlay">
  <div class="save-overlay-hint" id="save-overlay-hint"></div>
  <img id="save-overlay-img" alt="å•å®‰åœ–">
  <button class="save-overlay-close" id="save-overlay-close">é—œé–‰</button>
</div>
<div class="toast" id="toast"></div>

<script>
  // â”€â”€â”€ Time â”€â”€â”€
  function getTimeGreeting() {
    const h = new Date().getHours();
    if (h >= 5 && h < 12) return 'æ—©å®‰';
    if (h >= 12 && h < 18) return 'åˆå®‰';
    return 'æ™šå®‰';
  }
  function getDateTimeStr() {
    const now = new Date();
    const m = now.getMonth() + 1, d = now.getDate();
    const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][now.getDay()];
    const hours = now.getHours(), mins = String(now.getMinutes()).padStart(2,'0');
    const period = hours < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ', h12 = hours % 12 || 12;
    return `${m}æœˆ${d}æ—¥ æ˜ŸæœŸ${w} ${period}${h12}:${mins}`;
  }

  // â”€â”€â”€ Data â”€â”€â”€
  const BASIC = ['æ—©å®‰','åˆå®‰','æ™šå®‰','åƒé£½äº†å—','å¤©å†·è¨˜å¾—åŠ è¡£æœ','è¨˜å¾—å¤šå–æ°´'];
  
  const NEW_GREETINGS = [
    'è¦ªæ„›çš„æœ‹å‹ï¼è¨˜å¾—æ¯å¤©å¤šæ„›è‡ªå·±ä¸€é»é»å‘¦ã€‚', 'æ¯å¤©ä¿æŒå¥½å¿ƒæƒ…ï¼Œæ‰èƒ½å……å¯¦åˆå¿«æ´»ï¼', 'ç¥ä¸€åˆ‡å®‰å¥½ï¼Œé †åˆ©ï¼Œå¹¸ç¦',
    'ç´¯äº†ï¼Œä¸è¦ç¡¬æ’è‘—', 'å‘¼å¸å§ï¼Œä½ é‚„æ´»è‘—', 'ç”Ÿå‘½åªå­˜åœ¨æ–¼ç•¶ä¸‹ã€‚å¤±å»äº†ç•¶ä¸‹å°±æ˜¯å¤±å»äº†ç”Ÿå‘½',
    'æˆ‘å€‘çš„æ„›ï¼Œæ‡‰è©²æ˜¯ç‚ºæˆ‘å€‘æ‰€æ„›çš„äººå¸¶ä¾†å’Œå¹³å’Œå¹¸ç¦ã€‚', 'å¾®ç¬‘å§ï¼Œç”Ÿå‘½æ˜¯ç¾å¥½çš„', 'ç¨®å­å†é£½æ»¿ï¼Œä¹Ÿéœ€è¦å¤§åœ°çš„æ»‹é¤Š',
    'æƒ³åƒåŠ›æ¯”çŸ¥è­˜æ›´é‡è¦', 'åªæœ‰æ”¾æ£„å˜—è©¦çš„ï¼Œæ‰æ˜¯å¤±æ•—è€…', 'å”¯æœ‰é‚£äº›ç•°æƒ³å¤©é–‹çš„äººï¼Œæ‰èƒ½å®Œæˆä¸å¯èƒ½çš„äº‹',
    'äººç”Ÿå°±åƒé¨å–®è»Šã€‚æƒ³ä¿æŒå¹³è¡¡å°±å¾—å¾€å‰èµ°', 'å‹èª¼èƒ½å¢é€²å¿«æ¨‚ï¼Œæ¸›å°‘ç—›è‹¦', 'æœ‰åƒ¹å€¼çš„æ±è¥¿ï¼Œéƒ½éœ€è¦ä»˜å‡ºä»£åƒ¹',
    'æˆåŠŸçš„å”¯ä¸€ç§˜è¨£â€”â€”å …æŒæœ€å¾Œä¸€åˆ†é˜', 'æ¨é–‹çª—ï¼Œæ“æŠ±é™½å…‰ï¼Œç¥ä½ ä»Šå¤©æ„‰å¿«ç¾å¥½', 'å¥½å¥½ç…§é¡§è‡ªå·±ï¼Œå°±æ˜¯ä»Šå¤©æœ€å¥½çš„ç¥ç¦ï¼',
    'é¢å°è¤‡é›œï¼Œä¿æŒæ­¡å–œã€‚åŠ æ²¹ï¼', 'é¡˜ä½ å¾®ç¬‘ä»Šå¤©ï¼Œå¿«æ¨‚æ°¸é ï¼', 'ç„¡è«–èº«å±…ä½•è™•ï¼Œå¦‚æœå¾—ä»¥å·å¾—ä¸€åˆ»å®‰é–’åä¸‹ä¾†ï¼Œå°±ç•¶äº«å—é‚£ä¸€åˆ»ï¼Œäº«å—æ²’æœ‰ä»€éº¼è¦åšï¼Œåƒ…åƒ…åªæ˜¯äº«å—ä½ çš„å‘¼å¸ã€‚',
    'å®Œç¾ä¸‹åˆåˆä¾†åˆ°ï¼Œç¥ä½ é€™å¤©å¥½æƒ…ç·’ï¼Œå·¥ä½œé †åˆ©ï¼Œç”Ÿæ´»ç”œç¾', 'å¿™ç¢Œç¸½æ˜¯ç†ç”±ï¼Œç‰½æ›ç¸½æ˜¯ä¸»é¡Œï¼Œé»˜é»˜åœ°ç¥ç¦ä½ ï¼Œç…§é¡§å¥½è‡ªå·±ï¼Œä¸€åˆ‡å¹³å®‰é †åˆ©ï¼',
    'ä¸€å¤©å·²ç¶“éå»ä¸€åŠï¼Œèªªè²ä¸‹åˆå¥½ï¼Œæ‰“èµ·ç²¾ç¥ï¼Œç›¡å¿«å®Œæˆå·¥ä½œï¼Œæ—©é»å›å®¶åƒé£¯ï¼', 'åœ¨æ™‚å…‰ç©¿æ¢­çš„æ—¥å­è£¡ï¼Œå¿™ç¢Œçš„ç¸½æ˜¯èº«å½±ï¼Œå¤šä¿é‡èº«é«”ï¼Œé¡˜ä½ å¹¸ç¦å®‰åº·ï¼Œå¿«æ¨‚è‡ªåœ¨ï¼',
    'å–æ¯èŒ¶ï¼Œä¼‘æ¯æ™‚åˆ»å°‘ä¸äº†ï¼Œç¥ç¦åˆ°ï¼Œè½‰æ›å¿ƒæƒ…æ›´ç¾å¦™ï¼', 'å‹ç´¯äº†ä¸€å¤©ï¼Œé¡˜æˆ‘è¼•è¼•çš„ä¸€è²å•å€™ï¼Œä¼´ä½ è¼•é¬†å…¥å¤¢ï¼Œæ™šå®‰ï¼',
    'å®‰éœæ¬£è³å¤œæ™¯ï¼Œå°‡å–§é¬§æ­¸é›¶ï¼›æ…¢æ…¢å–æ¯ç‰›å¥¶ï¼Œå°‡å¿™ç¢Œæ­¸é›¶ã€‚æ™šå®‰ï¼', 'é¡˜ä½ çš„äººç”Ÿå¹³å®‰ä¸€ç¨‹åˆä¸€ç¨‹ï¼Œé¡˜æ‰€æœ‰çš„ç¾å¥½è£æ»¿æ‚¨çš„å¤¢ï¼Œç¥ä½ ä»Šæ™šå¥½å¤¢ã€‚',
    'ä¸è¦æäººæ†‚å¤©ï¼Œç…©æƒ±ä¸¦ä¸æœƒæ¸›å°‘æ˜å¤©çš„è² æ“”ï¼Œå»æœƒå¤±å»ä»Šå¤©çš„å¿«æ¨‚ï¼Œæ™šå®‰ï¼', 'è®“ç–²æ†Šçš„èº«é«”æ…¢æ…¢å…¥ç¡ï¼Œé¡˜ä½ åšä¸€å€‹å¥½å¤¢ï¼Œå¤¢ä¸­æµæ˜Ÿæ»‘è½è®“ä½ é¡˜æœ›æˆçœŸï¼Œæ™šå®‰ï¼',
    'å¦‚æœå¿ƒå€¦äº†å°±æ‰¾å€‹æ™‚é–“ä¼‘æ¯ï¼Œå¦ç„¶é‡‹æ‡·äº†æ‰èƒ½å¥½å¥½çš„æ”¾é¬†ã€‚æ™šå®‰ï¼', 'é¡˜çšæ½”çš„æœˆå…‰ç‘æ»¿çª—å‰ï¼Œé¡˜ç¹æ˜Ÿçš„é»é»ä¼´ä½ å¾®ç¬‘å…¥çœ ï¼Œé¡˜è¼•è¼•çš„ç¥ç¦é€ä½ ä¸€â€‹â€‹å¤œé¦™ç”œã€‚æ™šå®‰ï¼',
    'æ™šéœæŠ«è‘—æˆ‘çš„å•å€™ï¼Œçµ¦ä½ å¸¶ä¾†æº«æš–ï¼›å¤œé¢¨ç¨è‘—æˆ‘çš„ç‰½æ›ï¼Œç¥ä½ æ™šå®‰å¥½å¤¢ï¼'
  ];

  const DISPLAY_GREETINGS = NEW_GREETINGS.slice(0, 10);
  
  const FONTS = {
    gensenrounded: '"Noto Sans TC", sans-serif',
    wenkai: '"LXGW WenKai TC", serif',
    notoserif: '"Noto Serif TC", serif',
    notosans: '"Noto Sans TC", sans-serif',
    zenmaru: '"Zen Maru Gothic", sans-serif',
    jhenghei: '"Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", "Noto Sans TC", sans-serif',
    hanserif: '"Noto Serif TC", "Source Han Serif TC", serif',
  };

  // â”€â”€â”€ Sticker Config â”€â”€â”€
  const createEmojiSVG = (emoji) => `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="80">${emoji}</text></svg>`)}`;
  const createCustomSVG = (content) => `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">${content}</svg>`)}`;
  
  const STICKERS = [
    { id:'sunflower', name:'å‘æ—¥è‘µ', src: createEmojiSVG('ğŸŒ»') },
    { id:'butterfly', name:'è´è¶', src: createEmojiSVG('ğŸ¦‹') },
    { id:'sun', name:'å¤ªé™½', src: createCustomSVG(`<circle cx="50" cy="50" r="22" fill="#FFCA28"/><g stroke="#FFCA28" stroke-width="6" stroke-linecap="round"><line x1="50" y1="10" x2="50" y2="18"/><line x1="50" y1="82" x2="50" y2="90"/><line x1="10" y1="50" x2="18" y2="50"/><line x1="82" y1="50" x2="90" y2="50"/><line x1="22" y1="22" x2="28" y2="28"/><line x1="78" y1="78" x2="72" y2="72"/><line x1="22" y1="78" x2="28" y2="72"/><line x1="78" y1="22" x2="72" y2="28"/></g>`) },
    { id:'lotus', name:'è“®èŠ±', src: createCustomSVG(`<path d="M50 85 C 15 85 5 50 25 40 C 35 45 40 70 50 85 Z" fill="#81C784"/><path d="M50 85 C 85 85 95 50 75 40 C 65 45 60 70 50 85 Z" fill="#81C784"/><path d="M50 85 C 20 70 15 35 35 25 C 45 35 45 60 50 85 Z" fill="#FF9EBB"/><path d="M50 85 C 80 70 85 35 65 25 C 55 35 55 60 50 85 Z" fill="#FF9EBB"/><path d="M50 85 C 25 80 20 45 30 35 C 40 50 45 65 50 85 Z" fill="#FF7096"/><path d="M50 85 C 75 80 80 45 70 35 C 60 50 55 65 50 85 Z" fill="#FF7096"/><path d="M50 85 C 35 85 35 30 50 15 C 65 30 65 85 50 85 Z" fill="#FF477E"/>`) },
    { id:'heart', name:'æ„›å¿ƒ', src: createCustomSVG(`<path d="M 50 30 A 20 20 0 0 0 10 30 C 10 60 50 85 50 85 C 50 85 90 60 90 30 A 20 20 0 0 0 50 30 Z" fill="#FF4B4B"/><path d="M 22 25 A 12 12 0 0 1 35 15" fill="none" stroke="#FFC0CB" stroke-width="4" stroke-linecap="round"/>`) },
    { id:'coffee', name:'å’–å•¡', src: createCustomSVG(`<path d="M 25 30 L 25 70 C 25 85 75 85 75 70 L 75 30 Z" fill="#FFE082"/><path d="M 75 40 C 95 40 95 65 75 65" fill="none" stroke="#FFE082" stroke-width="8" stroke-linecap="round"/><path d="M 35 30 L 65 30" stroke="#8D6E63" stroke-width="6" stroke-linecap="round"/><circle cx="40" cy="55" r="3" fill="#5D4037"/><circle cx="60" cy="55" r="3" fill="#5D4037"/><path d="M 45 60 Q 50 65 55 60" fill="none" stroke="#5D4037" stroke-width="3" stroke-linecap="round"/><path d="M 40 20 Q 35 10 45 5" fill="none" stroke="#BDBDBD" stroke-width="4" stroke-linecap="round"/><path d="M 60 20 Q 55 10 65 5" fill="none" stroke="#BDBDBD" stroke-width="4" stroke-linecap="round"/>`) },
    { id:'sparkle', name:'æ˜Ÿæ˜Ÿ', src: createCustomSVG(`<polygon points="50,15 61,35 84,35 66,52 73,75 50,60 27,75 34,52 16,35 39,35" fill="#FFD54F" stroke="#FFB300" stroke-width="3" stroke-linejoin="round"/><circle cx="42" cy="48" r="3" fill="#8D6E63"/><circle cx="58" cy="48" r="3" fill="#8D6E63"/><path d="M 47 54 Q 50 58 53 54" fill="none" stroke="#8D6E63" stroke-width="3" stroke-linecap="round"/>`) },
    { id:'sakura', name:'æ«»èŠ±', src: createEmojiSVG('ğŸŒ¸') },
    { id:'clover', name:'å¹¸é‹è‰', src: createEmojiSVG('ğŸ€') }
  ];

  // â”€â”€â”€ State â”€â”€â”€
  let canvasRatio = '1:1'; // '1:1' or '9:16'
  let bgColor = '#EBF3FB';
  let greetingColor = '#FFFFFF';
  let fontKey = 'gensenrounded';
  
  // Interaction State
  let bgState = null; // { img, x, y, w, h }
  let textState = { x: 540, y: 540, fontSize: 72 };
  const activeStickers = new Set();
  const stickerImages = {};
  const stickerState = {};
  
  let hitBoxes = []; // ç”¨æ–¼è¨˜éŒ„ç•«é¢ä¸Šçš„å…ƒä»¶é»æ“Šç¯„åœ
  let selectedItem = null; // { type: 'text' } or { type: 'sticker', id: 'lotus' } or { type: 'bg' }
  
  // Single pointer state
  let isDragging = false;
  let isResizing = false;
  let startX, startY;
  let startObjX, startObjY, startObjW, startObjSize;

  // Multi-pointer (Pinch-to-zoom) state
  const pointerCache = new Map();
  let initialPinchDist = -1;
  let initialPinchObjSize = -1;

  // â”€â”€â”€ DOM â”€â”€â”€
  const uploadArea = document.getElementById('upload-area');
  const uploadInput = document.getElementById('upload-input');
  const previewThumb = document.getElementById('preview-thumb');
  const textInput = document.getElementById('text-input');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const btnDownload = document.getElementById('btn-download');
  const previewWrap = document.getElementById('preview-wrap');
  const toastEl = document.getElementById('toast');

  // â”€â”€â”€ Helpers â”€â”€â”€
  function clearGreetingActive() {
    document.querySelectorAll('.greeting-btn, .wisdom-btn').forEach(b => b.classList.remove('active'));
  }
  function fillBasic(t) { textInput.value = `${t}ï¼\n${getDateTimeStr()}`; draw(); }
  function fillWisdom(t) { textInput.value = `${t}\n${getDateTimeStr()}`; draw(); }

  function getCanvasSize() {
    const cw = 1080;
    const ch = canvasRatio === '1:1' ? 1080 : 1920;
    return { cw, ch };
  }

  // â”€â”€â”€ Ratio & Clear Buttons â”€â”€â”€
  document.querySelectorAll('.ratio-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      canvasRatio = btn.dataset.ratio;
      previewWrap.style.aspectRatio = canvasRatio === '1:1' ? '1 / 1' : '9 / 16';
      
      // è‡ªå‹•å°‡æ–‡å­—ç½®ä¸­ä»¥é©æ‡‰æ–°ç‰ˆå‹
      const { cw, ch } = getCanvasSize();
      textState.x = cw / 2;
      textState.y = ch / 2;
      
      draw();
    });
  });

  document.getElementById('btn-clear').addEventListener('click', () => {
    bgState = null;
    activeStickers.clear();
    textInput.value = '';
    selectedItem = null;
    
    // UI æ¸…ç©º
    uploadArea.classList.remove('has-image');
    previewThumb.src = '';
    clearGreetingActive();
    
    // æ–‡å­—ç½®ä¸­
    const { cw, ch } = getCanvasSize();
    textState.x = cw / 2;
    textState.y = ch / 2;
    textState.fontSize = 72;
    
    draw();
    toast('å·²é‡ç½®ç•«å¸ƒï¼');
  });

  // â”€â”€â”€ Greeting Buttons â”€â”€â”€
  const autoG = getTimeGreeting();
  BASIC.forEach(g => {
    const btn = document.createElement('button');
    btn.className = 'greeting-btn' + (g === autoG ? ' active' : '');
    btn.textContent = g;
    btn.addEventListener('click', () => { clearGreetingActive(); btn.classList.add('active'); fillBasic(g); });
    document.getElementById('basic-row').appendChild(btn);
  });
  
  DISPLAY_GREETINGS.forEach(w => {
    const btn = document.createElement('button');
    btn.className = 'wisdom-btn';
    btn.textContent = w.length > 8 ? w.substring(0, 8) + '...' : w;
    btn.title = w;
    btn.addEventListener('click', () => { clearGreetingActive(); btn.classList.add('active'); fillWisdom(w); });
    document.getElementById('wisdom-row').appendChild(btn);
  });
  
  (function() {
    const btn = document.createElement('button');
    btn.className = 'wisdom-btn random-btn';
    btn.textContent = 'éš¨æ©Ÿç”¢ç”Ÿ ğŸ²';
    btn.addEventListener('click', () => {
      clearGreetingActive();
      btn.classList.add('active');
      fillWisdom(NEW_GREETINGS[Math.floor(Math.random() * NEW_GREETINGS.length)]);
    });
    document.getElementById('wisdom-row').appendChild(btn);
  })();
  
  fillBasic(autoG);

  // â”€â”€â”€ Sticker Setup â”€â”€â”€
  const stickerGrid = document.getElementById('sticker-grid');

  STICKERS.forEach(s => {
    const img = new Image();
    img.src = s.src;
    img.onload = () => draw();
    stickerImages[s.id] = img;
    
    const wrap = document.createElement('div');
    wrap.className = 'sticker-item-wrap';
    const thumb = document.createElement('div');
    thumb.className = 'sticker-thumb';
    const thumbImg = document.createElement('img');
    thumbImg.src = s.src;
    thumb.appendChild(thumbImg);
    
    thumb.addEventListener('click', () => {
      if (activeStickers.has(s.id)) {
        activeStickers.delete(s.id);
        thumb.classList.remove('active');
        if (selectedItem && selectedItem.id === s.id) selectedItem = null;
      } else {
        activeStickers.add(s.id);
        thumb.classList.add('active');
        
        const { cw, ch } = getCanvasSize();
        stickerState[s.id] = { x: cw/2 - 90, y: ch/2 - 90, size: 180 };
        selectedItem = { type: 'sticker', id: s.id };
      }
      draw();
    });
    const label = document.createElement('div');
    label.className = 'sticker-name';
    label.textContent = s.name;
    wrap.appendChild(thumb); wrap.appendChild(label);
    stickerGrid.appendChild(wrap);
  });

  // â”€â”€â”€ Upload â”€â”€â”€
  uploadArea.addEventListener('click', () => uploadInput.click());
  uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
  uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
  uploadArea.addEventListener('drop', e => {
    e.preventDefault(); uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });
  uploadInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

  function handleFile(file) {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const { cw, ch } = getCanvasSize();
        // åˆå§‹ä»¥ä¸Šå‚³åœ–ç‰‡èƒ½å®Œæ•´é¡¯ç¤ºæ–¼ç•«å¸ƒå…§ç‚ºä¸»
        const sc = Math.min(cw / img.width, ch / img.height);
        
        bgState = {
          img: img,
          w: img.width * sc,
          h: img.height * sc,
          x: (cw - img.width * sc) / 2,
          y: (ch - img.height * sc) / 2
        };

        previewThumb.src = e.target.result;
        uploadArea.classList.add('has-image');
        selectedItem = { type: 'bg', id: 'bg' };
        draw();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // â”€â”€â”€ UI Events â”€â”€â”€
  document.querySelectorAll('.font-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      fontKey = btn.dataset.font;
      const fam = FONTS[fontKey].split(',')[0].trim().replace(/"/g,'');
      try { await document.fonts.load(`bold ${textState.fontSize}px "${fam}"`); } catch(e){}
      draw();
    });
  });

  document.querySelectorAll('.text-color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      document.querySelectorAll('.text-color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      greetingColor = dot.dataset.color;
      draw();
    });
  });

  document.querySelectorAll('.bg-color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      document.querySelectorAll('.bg-color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      bgColor = dot.dataset.color;
      draw();
    });
  });

  document.getElementById('btn-center-text').addEventListener('click', () => {
    const { cw, ch } = getCanvasSize();
    textState.x = cw / 2;
    textState.y = ch / 2;
    draw();
  });

  textInput.addEventListener('input', draw);

  // â”€â”€â”€ Canvas Interaction Logic â”€â”€â”€
  function getPointerPos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  }

  canvas.addEventListener('pointerdown', (e) => {
    document.activeElement.blur(); // éš±è—æ‰‹æ©Ÿéµç›¤
    canvas.setPointerCapture(e.pointerId); // æ•ç²æŒ‡æ¨™ï¼Œç¢ºä¿æ»‘å‡ºé‚Šç•Œä»èƒ½è¿½è¹¤
    pointerCache.set(e.pointerId, getPointerPos(e));
    
    const pos = getPointerPos(e);

    // å¦‚æœæœ‰å…©æŒ‡ä»¥ä¸ŠæŒ‰ä¸‹ï¼Œä¸”ç›®å‰æœ‰é¸å–ç‰©ä»¶ï¼Œé€²å…¥é›™æŒ‡ç¸®æ”¾æ¨¡å¼
    if (pointerCache.size >= 2 && selectedItem) {
      isDragging = false; // å–æ¶ˆå–®æŒ‡æ‹–æ›³
      isResizing = false;
      const pts = Array.from(pointerCache.values());
      initialPinchDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      
      // è¨˜éŒ„é–‹å§‹ç¸®æ”¾å‰çš„ç‰©ä»¶å¤§å°
      if (selectedItem.type === 'text') initialPinchObjSize = textState.fontSize;
      else if (selectedItem.type === 'sticker') initialPinchObjSize = stickerState[selectedItem.id].size;
      else if (selectedItem.type === 'bg') initialPinchObjSize = bgState.w;
      return;
    }

    // å–®æŒ‡é»æ“Šé‚è¼¯
    if (pointerCache.size === 1) {
      let found = false;
      // åå‘è¿´åœˆï¼Œå„ªå…ˆé¸æ“‡æœ€ä¸Šå±¤(æœ€å¾Œç¹ªè£½)çš„ç‰©ä»¶æˆ–æ§åˆ¶é»
      for (let i = hitBoxes.length - 1; i >= 0; i--) {
        const b = hitBoxes[i];
        if (pos.x >= b.x && pos.x <= b.x + b.w && pos.y >= b.y && pos.y <= b.y + b.h) {
          selectedItem = { type: b.type, id: b.id };
          startX = pos.x;
          startY = pos.y;
          
          if (b.isHandle) {
            isResizing = true;
            if (b.type === 'text') startObjSize = textState.fontSize;
            else if (b.type === 'sticker') startObjSize = stickerState[b.id].size;
            else if (b.type === 'bg') startObjW = bgState.w;
          } else {
            isDragging = true;
            if (b.type === 'text') {
              startObjX = textState.x;
              startObjY = textState.y;
            } else if (b.type === 'sticker') {
              startObjX = stickerState[b.id].x;
              startObjY = stickerState[b.id].y;
            } else if (b.type === 'bg') {
              startObjX = bgState.x;
              startObjY = bgState.y;
            }
          }
          e.preventDefault(); // é˜²æ­¢æ‰‹æ©Ÿç•«é¢æ²å‹•
          draw();
          found = true;
          break;
        }
      }
      
      // é»æ“Šç©ºç™½è™•å–æ¶ˆé¸å–
      if (!found) {
        selectedItem = null;
        draw();
      }
    }
  });

  canvas.addEventListener('pointermove', (e) => {
    if (!pointerCache.has(e.pointerId)) return; // å¿½ç•¥æœªè¨˜éŒ„çš„æŒ‡æ¨™
    pointerCache.set(e.pointerId, getPointerPos(e));
    const pos = getPointerPos(e);
    
    // é›™æŒ‡ç¸®æ”¾é‚è¼¯
    if (pointerCache.size >= 2 && selectedItem && initialPinchDist > 0) {
      const pts = Array.from(pointerCache.values());
      const currentDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      const scale = currentDist / initialPinchDist;

      if (selectedItem.type === 'text') {
        textState.fontSize = Math.max(16, Math.min(300, initialPinchObjSize * scale));
      } else if (selectedItem.type === 'sticker') {
        stickerState[selectedItem.id].size = Math.max(40, Math.min(1200, initialPinchObjSize * scale));
      } else if (selectedItem.type === 'bg') {
        const aspect = bgState.w / bgState.h;
        bgState.w = Math.max(50, initialPinchObjSize * scale);
        bgState.h = bgState.w / aspect;
      }
      draw();
      return;
    }

    // å–®æŒ‡æ‹–æ›³/æ»‘é¼ æ¸¸æ¨™æ›´æ–°é‚è¼¯
    if (pointerCache.size === 1) {
      // æ›´æ–°æ»‘é¼ æ¸¸æ¨™åœ–ç¤º
      if (!isDragging && !isResizing) {
        let hoverHandle = false;
        let hoverBody = false;
        for (let i = hitBoxes.length - 1; i >= 0; i--) {
          const b = hitBoxes[i];
          if (pos.x >= b.x && pos.x <= b.x + b.w && pos.y >= b.y && pos.y <= b.y + b.h) {
            if (b.isHandle) hoverHandle = true;
            else hoverBody = true;
            break;
          }
        }
        canvas.style.cursor = hoverHandle ? 'nwse-resize' : (hoverBody ? 'move' : 'default');
      }

      // è™•ç†æ‹–æ›³æˆ–æ§åˆ¶é»ç¸®æ”¾
      if (!isDragging && !isResizing) return;
      const dx = pos.x - startX;
      const dy = pos.y - startY;

      if (isDragging) {
        if (selectedItem.type === 'text') {
          textState.x = startObjX + dx;
          textState.y = startObjY + dy;
        } else if (selectedItem.type === 'sticker') {
          stickerState[selectedItem.id].x = startObjX + dx;
          stickerState[selectedItem.id].y = startObjY + dy;
        } else if (selectedItem.type === 'bg') {
          bgState.x = startObjX + dx;
          bgState.y = startObjY + dy;
        }
      } else if (isResizing) {
        const delta = Math.max(dx, dy); // ä»¥è¼ƒå¤§ä½ç§»ä½œç‚ºç¸®æ”¾æ¯”ä¾‹
        if (selectedItem.type === 'text') {
          textState.fontSize = Math.max(16, Math.min(300, startObjSize + delta * 0.4));
        } else if (selectedItem.type === 'sticker') {
          stickerState[selectedItem.id].size = Math.max(40, Math.min(1200, startObjSize + delta));
        } else if (selectedItem.type === 'bg') {
          const aspect = bgState.w / bgState.h;
          bgState.w = Math.max(50, startObjW + delta);
          bgState.h = bgState.w / aspect;
        }
      }
      draw();
    }
  });

  const handlePointerUp = (e) => {
    pointerCache.delete(e.pointerId);
    if (pointerCache.size < 2) {
      initialPinchDist = -1; // è§£é™¤é›™æŒ‡ç¸®æ”¾é–å®š
    }
    if (pointerCache.size === 0) {
      isDragging = false;
      isResizing = false;
    }
  };

  canvas.addEventListener('pointerup', handlePointerUp);
  canvas.addEventListener('pointercancel', handlePointerUp);

  // â”€â”€â”€ Draw Canvas â”€â”€â”€
  function draw() {
    hitBoxes = []; // æ¯æ¬¡é‡ç¹ªæ™‚æ¸…ç©ºç¢°æ’åˆ¤å®šå€
    const { cw, ch } = getCanvasSize();
    canvas.width = cw; 
    canvas.height = ch;

    // 1. ç¹ªè£½ç´”åº•è‰²
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, cw, ch);

    // 2. ç¹ªè£½èƒŒæ™¯åœ–ç‰‡ (åŠ å…¥ç¢°æ’å€è®“ä½¿ç”¨è€…å¯ä»¥é¸å–/æ‹–æ‹‰)
    if (bgState && bgState.img) {
      ctx.drawImage(bgState.img, bgState.x, bgState.y, bgState.w, bgState.h);
      hitBoxes.push({ type: 'bg', id: 'bg', x: bgState.x, y: bgState.y, w: bgState.w, h: bgState.h });
    }

    // 3. ç¹ªè£½è²¼åœ–ä¸¦è¨˜éŒ„ä½ç½®
    STICKERS.forEach(s => {
      if (!activeStickers.has(s.id)) return;
      const img = stickerImages[s.id];
      const st = stickerState[s.id];
      if (img.complete) {
        ctx.drawImage(img, st.x, st.y, st.size, st.size);
        hitBoxes.push({ type: 'sticker', id: s.id, x: st.x, y: st.y, w: st.size, h: st.size });
      }
    });

    // 4. ç¹ªè£½æ–‡å­—ä¸¦è¨˜éŒ„ä½ç½®
    const mainText = textInput.value.trim();
    if (mainText) {
      const rawLines = mainText.split('\n').map(line => ({
        text: line,
        small: line.startsWith('â€”') || line.match(/^\d+æœˆ/)
      }));

      const fontFamily = FONTS[fontKey];
      const pad = 40;
      const maxTextWidth = cw - pad * 2;
      
      // è‡ªå‹•æ›è¡Œè¨ˆç®—
      const wrappedLines = [];
      rawLines.forEach(lineObj => {
        const size = lineObj.small ? Math.round(textState.fontSize * 0.6) : textState.fontSize;
        ctx.font = `bold ${size}px ${fontFamily}`;
        
        let currentLine = '';
        for (let i = 0; i < lineObj.text.length; i++) {
          const char = lineObj.text[i];
          const testLine = currentLine + char;
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxTextWidth && i > 0) {
            wrappedLines.push({ text: currentLine, small: lineObj.small });
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }
        wrappedLines.push({ text: currentLine, small: lineObj.small });
      });

      // è¨ˆç®—æ–‡å­—æ•´é«”é«˜åº¦èˆ‡æœ€å¤§å¯¬åº¦ï¼Œä¾›ç¹ªè£½é‚Šç•Œæ¡†ä½¿ç”¨
      let calculatedMaxWidth = 0;
      wrappedLines.forEach(line => {
        const size = line.small ? Math.round(textState.fontSize * 0.6) : textState.fontSize;
        ctx.font = `bold ${size}px ${fontFamily}`;
        calculatedMaxWidth = Math.max(calculatedMaxWidth, ctx.measureText(line.text).width);
      });
      
      const lineH = textState.fontSize * 1.5;
      const totalH = wrappedLines.length * lineH;
      
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      let startY = textState.y - (totalH / 2) + (lineH / 2);

      // é€è¡Œç¹ªè£½æ–‡å­—
      wrappedLines.forEach((line, i) => {
        const y = startY + i * lineH;
        const size = line.small ? Math.round(textState.fontSize * 0.6) : textState.fontSize;
        ctx.font = `bold ${size}px ${fontFamily}`;
        ctx.strokeStyle = 'rgba(0,0,0,0.6)';
        ctx.lineWidth = size * 0.12;
        ctx.lineJoin = 'round';
        ctx.strokeText(line.text, textState.x, y);
        ctx.fillStyle = greetingColor;
        ctx.fillText(line.text, textState.x, y);
      });

      // è¨˜éŒ„æ–‡å­—ç¢°æ’å€åŸŸ
      hitBoxes.push({
        type: 'text', id: 'text',
        x: textState.x - calculatedMaxWidth / 2,
        y: textState.y - totalH / 2,
        w: calculatedMaxWidth, h: totalH
      });
    }

    // 5. ç¹ªè£½é¸å–æ¡†èˆ‡ç¸®æ”¾æ§åˆ¶é»
    if (selectedItem) {
      const box = hitBoxes.find(b => b.type === selectedItem.type && b.id === selectedItem.id);
      if (box) {
        // è™›ç·šå¤–æ¡†
        ctx.strokeStyle = '#4A90E2';
        ctx.lineWidth = 3;
        ctx.setLineDash([8, 8]);
        ctx.strokeRect(box.x - 5, box.y - 5, box.w + 10, box.h + 10);
        ctx.setLineDash([]);
        
        // å³ä¸‹è§’ç¸®æ”¾é»
        const handleSize = 24;
        const hx = box.x + box.w + 5 - handleSize / 2;
        const hy = box.y + box.h + 5 - handleSize / 2;
        ctx.fillStyle = '#4A90E2';
        ctx.beginPath();
        ctx.arc(hx + handleSize/2, hy + handleSize/2, handleSize/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#FFFFFF';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // è¨˜éŒ„æ§åˆ¶é»çš„ç¢°æ’å€åŸŸ (ç•¥å¾®æ”¾å¤§ä»¥ä¾¿æ–¼é»æ“Š)
        hitBoxes.push({
          type: box.type, id: box.id, isHandle: true,
          x: hx - 15, y: hy - 15, w: handleSize + 30, h: handleSize + 30
        });
      }
    }
  }
  
  // åˆå§‹åŒ–æ™‚ç¹ªè£½ä¸€æ¬¡
  document.fonts.ready.then(draw);

  // â”€â”€â”€ Download â”€â”€â”€
  btnDownload.addEventListener('click', async () => {
    // ä¸‹è¼‰å‰æ¸…é™¤é¸å–ç‹€æ…‹ï¼Œé¿å…è™›ç·šæ¡†è¢«å­˜æª”
    selectedItem = null;
    draw();
    
    setTimeout(() => {
      const dataUrl = canvas.toDataURL('image/png');
      
      if (/Line\//i.test(navigator.userAgent) || /FBAN|FBAV|Instagram/i.test(navigator.userAgent)) {
        document.getElementById('save-overlay-img').src = dataUrl;
        document.getElementById('save-overlay-hint').innerHTML = 'ğŸ‘† é•·æŒ‰åœ–ç‰‡å„²å­˜<br>å³å¯åˆ†äº«çµ¦è¦ªå‹';
        document.getElementById('save-overlay').classList.add('show');
        return;
      }

      const link = document.createElement('a');
      link.download = `å•å®‰åœ–_${new Date().getTime()}.png`;
      link.href = dataUrl;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      toast('âœ… åœ–ç‰‡å·²æˆåŠŸä¸‹è¼‰ï¼');
    }, 50); // çµ¦ Canvas ä¸€é»é»æ™‚é–“æ›´æ–°ç•«é¢
  });

  document.getElementById('save-overlay-close').addEventListener('click', () => document.getElementById('save-overlay').classList.remove('show'));

  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 2500);
  }
</script>
</body>
</html>
